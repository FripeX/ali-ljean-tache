{"version":3,"sources":["../src/wiki.js"],"names":["wiki","defaultOptions","apiUrl","origin","res","query","redirects","length","apiOptions","prop","inprop","ppprop","titles","to","list","srsearch","srlimit","limit","search","map","article","title","catch","message","opensearch","err","namespace","action","then","handleRedirect","Object","keys","pages","id","Error","console","log","assign","options","random","rnnamespace","rnlimit","page","geoSearch","gsradius","radius","gscoord","lat","lon","geosearch","findById","pageids","pageid","find","results","predicate","name","allPages","allCategories","pagesInCategory","cmtitle","category","prefixSearch","pslimit","psprofile","pssearch","prefixsearch","mostViewed","mostviewed","count","api","params"],"mappings":"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","file":"wiki.js","sourcesContent":["'use strict';\n\nimport { pagination, api, aggregate } from './util';\nimport wikiPage from './page';\n\n/**\n * @namespace\n * @constant\n * @property {string} apiUrl - URL of Wikipedia API\n * @property {string} headers - Headers to pass through to the API request\n * @property {string} origin - When accessing the API using a cross-domain AJAX\n * request (CORS), set this to the originating domain. This must be included in\n * any pre-flight request, and therefore must be part of the request URI (not\n * the POST body). This must match one of the origins in the Origin header\n * exactly, so it has to be set to something like https://en.wikipedia.org or\n * https://meta.wikimedia.org. If this parameter does not match the Origin\n * header, a 403 response will be returned. If this parameter matches the Origin\n * header and the origin is whitelisted, an Access-Control-Allow-Origin header\n * will be set.\n */\nconst defaultOptions = {\n\tapiUrl: 'http://en.wikipedia.org/w/api.php',\n\torigin: '*'\n};\n\n/**\n * wiki\n * @example\n * wiki({ apiUrl: 'http://fr.wikipedia.org/w/api.php' }).search(...);\n * @namespace Wiki\n * @param  {Object} options\n * @return {Object} - wiki (for chaining methods)\n */\nexport default function wiki(options = {}) {\n\tif (this instanceof wiki) {\n\t\t// eslint-disable-next-line\n\t\tconsole.log(\n\t\t\t'Please do not use wikijs ^1.0.0 as a class. Please see the new README.'\n\t\t);\n\t}\n\n\tconst apiOptions = Object.assign({}, defaultOptions, options);\n\n\tfunction handleRedirect(res) {\n\t\tif (res.query.redirects && res.query.redirects.length === 1) {\n\t\t\treturn api(apiOptions, {\n\t\t\t\tprop: 'info|pageprops',\n\t\t\t\tinprop: 'url',\n\t\t\t\tppprop: 'disambiguation',\n\t\t\t\ttitles: res.query.redirects[0].to\n\t\t\t});\n\t\t}\n\t\treturn res;\n\t}\n\n\t/**\n\t * Search articles\n\t * @example\n\t * wiki.search('star wars').then(data => console.log(data.results.length));\n\t * @example\n\t * wiki.search('star wars').then(data => {\n\t * \tdata.next().then(...);\n\t * });\n\t * @method Wiki#search\n\t * @param  {string} query - keyword query\n\t * @param  {Number} [limit] - limits the number of results\n\t * @return {Promise} - pagination promise with results and next page function\n\t */\n\tfunction search(query, limit = 50) {\n\t\treturn pagination(\n\t\t\tapiOptions,\n\t\t\t{\n\t\t\t\tlist: 'search',\n\t\t\t\tsrsearch: query,\n\t\t\t\tsrlimit: limit\n\t\t\t},\n\t\t\tres => res.query.search.map(article => article.title)\n\t\t).catch(err => {\n\t\t\tif (err.message === '\"text\" search is disabled.') {\n\t\t\t\t// Try backup search method\n\t\t\t\treturn opensearch(query, limit);\n\t\t\t}\n\t\t\tthrow err;\n\t\t});\n\t}\n\n\t/**\n\t * Search articles using \"fuzzy\" prefixsearch\n\t * @example\n\t * wiki.prefixSearch('star wars').then(data => console.log(data.results.length));\n\t * @example\n\t * wiki.prefixSearch('star wars').then(data => {\n\t * \tdata.next().then(...);\n\t * });\n\t * @method Wiki#prefixSearch\n\t * @param  {string} query - keyword query\n\t * @param  {Number} [limit] - limits the number of results\n\t * @return {Promise} - pagination promise with results and next page function\n\t */\n\tfunction prefixSearch(query, limit = 50) {\n\t\treturn pagination(\n\t\t\tapiOptions,\n\t\t\t{\n\t\t\t\tlist: 'prefixsearch',\n\t\t\t\tpslimit: limit,\n\t\t\t\tpsprofile: 'fuzzy',\n\t\t\t\tpssearch: query\n\t\t\t},\n\t\t\tres => res.query.prefixsearch.map(article => article.title)\n\t\t);\n\t}\n\n\t/**\n\t * Opensearch (mainly used as a backup to normal text search)\n\t * @param  {string} query - keyword query\n\t * @param  {Number} limit - limits the number of results\n\t * @return {Array}       List of page title results\n\t */\n\tfunction opensearch(query, limit = 50) {\n\t\treturn api(apiOptions, {\n\t\t\tsearch: query,\n\t\t\tlimit,\n\t\t\tnamespace: 0,\n\t\t\taction: 'opensearch',\n\t\t\tredirects: undefined\n\t\t}).then(res => res[1]);\n\t}\n\n\t/**\n\t * Random articles\n\t * @example\n\t * wiki.random(3).then(results => console.log(results[0]));\n\t * @method Wiki#random\n\t * @param  {Number} [limit] - limits the number of random articles\n\t * @return {Promise} - List of page titles\n\t */\n\tfunction random(limit = 1) {\n\t\treturn api(apiOptions, {\n\t\t\tlist: 'random',\n\t\t\trnnamespace: 0,\n\t\t\trnlimit: limit\n\t\t}).then(res => res.query.random.map(article => article.title));\n\t}\n\n\t/**\n\t * Get Page\n\t * @example\n\t * wiki.page('Batman').then(page => console.log(page.pageid));\n\t * @method Wiki#page\n\t * @param  {string} title - title of article\n\t * @return {Promise}\n\t */\n\tfunction page(title) {\n\t\treturn api(apiOptions, {\n\t\t\tprop: 'info|pageprops',\n\t\t\tinprop: 'url',\n\t\t\tppprop: 'disambiguation',\n\t\t\ttitles: title\n\t\t})\n\t\t\t.then(handleRedirect)\n\t\t\t.then(res => {\n\t\t\t\tconst id = Object.keys(res.query.pages)[0];\n\t\t\t\tif (!id || id === '-1') {\n\t\t\t\t\tthrow new Error('No article found');\n\t\t\t\t}\n\t\t\t\treturn wikiPage(res.query.pages[id], apiOptions);\n\t\t\t});\n\t}\n\n\t/**\n\t * Get Page by PageId\n\t * @example\n\t * wiki.findById(4335).then(page => console.log(page.title));\n\t * @method Wiki#findById\n\t * @param {integer} pageid, id of the page\n\t * @return {Promise}\n\t */\n\tfunction findById(pageid) {\n\t\treturn api(apiOptions, {\n\t\t\tprop: 'info|pageprops',\n\t\t\tinprop: 'url',\n\t\t\tppprop: 'disambiguation',\n\t\t\tpageids: pageid\n\t\t})\n\t\t\t.then(handleRedirect)\n\t\t\t.then(res => {\n\t\t\t\tconst id = Object.keys(res.query.pages)[0];\n\t\t\t\tif (!id || id === '-1') {\n\t\t\t\t\tthrow new Error('No article found');\n\t\t\t\t}\n\t\t\t\treturn wikiPage(res.query.pages[id], apiOptions);\n\t\t\t});\n\t}\n\n\t/**\n\t * Find page by query and optional predicate\n\t * @example\n\t * wiki.find('luke skywalker').then(page => console.log(page.title));\n\t * @method Wiki#find\n\t * @param {string} search query\n\t * @param {function} [predicate] - testing function for choosing which page result to fetch. Default is first result.\n\t * @return {Promise}\n\t */\n\tfunction find(query, predicate = results => results[0]) {\n\t\treturn search(query)\n\t\t\t.then(res => predicate(res.results))\n\t\t\t.then(name => page(name));\n\t}\n\n\t/**\n\t * Geographical Search\n\t * @example\n\t * wiki.geoSearch(32.329, -96.136).then(titles => console.log(titles.length));\n\t * @method Wiki#geoSearch\n\t * @param  {Number} lat - latitude\n\t * @param  {Number} lon - longitude\n\t * @param  {Number} [radius=1000] - search radius in kilometers (default: 1km)\n\t * @return {Promise} - List of page titles\n\t */\n\tfunction geoSearch(lat, lon, radius = 1000) {\n\t\treturn api(apiOptions, {\n\t\t\tlist: 'geosearch',\n\t\t\tgsradius: radius,\n\t\t\tgscoord: `${lat}|${lon}`\n\t\t}).then(res => res.query.geosearch.map(article => article.title));\n\t}\n\n\t/**\n\t * @summary Find the most viewed pages with counts\n\t * @example\n\t * wiki.mostViewed().then(list => console.log(`${list[0].title}: ${list[0].count}`))\n\t * @method Wiki#mostViewed\n\t * @returns {Promise} - Array of {title,count}\n\t */\n\tfunction mostViewed() {\n\t\treturn api(apiOptions, {\n\t\t\taction: 'query',\n\t\t\tlist: 'mostviewed'\n\t\t}).then(res =>\n\t\t\tres.query.mostviewed.map(({ title, count }) => ({ title, count }))\n\t\t);\n\t}\n\n\t/**\n\t * Fetch all page titles in wiki\n\t * @method Wiki#allPages\n\t * @return {Array} Array of pages\n\t */\n\tfunction allPages() {\n\t\treturn aggregate(apiOptions, {}, 'allpages', 'title', 'ap');\n\t}\n\n\t/**\n\t * Fetch all categories in wiki\n\t * @method Wiki#allCategories\n\t * @return {Array} Array of categories\n\t */\n\tfunction allCategories() {\n\t\treturn aggregate(apiOptions, {}, 'allcategories', '*', 'ac');\n\t}\n\n\t/**\n\t * Fetch all pages in category\n\t * @method Wiki#pagesInCategory\n\t * @param  {String} category Category to fetch from\n\t * @return {Array} Array of pages\n\t */\n\tfunction pagesInCategory(category) {\n\t\treturn aggregate(\n\t\t\tapiOptions,\n\t\t\t{\n\t\t\t\tcmtitle: category\n\t\t\t},\n\t\t\t'categorymembers',\n\t\t\t'title',\n\t\t\t'cm'\n\t\t);\n\t}\n\n\t/**\n\t * @summary Helper function to query API directly\n\t * @method Wiki#api\n\t * @param {Object} params [https://www.mediawiki.org/wiki/API:Query](https://www.mediawiki.org/wiki/API:Query)\n\t * @returns {Promise} Query Response\n\t * @example\n\t * wiki().api({\n\t *\taction: 'parse',\n\t *\tpage: 'Pet_door'\n\t * }).then(res => res.parse.title.should.equal('Pet door'));\n\t */\n\tfunction rawApi(params) {\n\t\treturn api(apiOptions, params);\n\t}\n\n\treturn {\n\t\tsearch,\n\t\trandom,\n\t\tpage,\n\t\tgeoSearch,\n\t\toptions,\n\t\tfindById,\n\t\tfind,\n\t\tallPages,\n\t\tallCategories,\n\t\tpagesInCategory,\n\t\topensearch,\n\t\tprefixSearch,\n\t\tmostViewed,\n\t\tapi: rawApi\n\t};\n}\n"]}