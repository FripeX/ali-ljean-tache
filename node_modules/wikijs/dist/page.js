'use strict';Object.defineProperty(exports,'__esModule',{value:!0});var _slicedToArray=function(){function c(d,e){var f=[],g=!0,h=!1,j=void 0;try{for(var l,k=d[Symbol.iterator]();!(g=(l=k.next()).done)&&(f.push(l.value),!(e&&f.length===e));g=!0);}catch(m){h=!0,j=m}finally{try{!g&&k['return']&&k['return']()}finally{if(h)throw j}}return f}return function(d,e){if(Array.isArray(d))return d;if(Symbol.iterator in Object(d))return c(d,e);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),_typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(c){return typeof c}:function(c){return c&&'function'==typeof Symbol&&c.constructor===Symbol&&c!==Symbol.prototype?'symbol':typeof c};exports.default=wikiPage;var _util=require('./util'),_infoboxParser=require('infobox-parser'),_infoboxParser2=_interopRequireDefault(_infoboxParser),_cheerio=require('cheerio'),_cheerio2=_interopRequireDefault(_cheerio),_coordinates=require('./coordinates');function _interopRequireDefault(c){return c&&c.__esModule?c:{default:c}}function _toConsumableArray(c){if(Array.isArray(c)){for(var d=0,e=Array(c.length);d<c.length;d++)e[d]=c[d];return e}return Array.from(c)}var get=function(c,d){for(var e=arguments.length,f=Array(2<e?e-2:0),g=2;g<e;g++)f[g-2]=arguments[g];return void 0===c||void 0===d?c:'function'==typeof d?get.apply(void 0,[d(c)].concat(f)):get.apply(void 0,[c[d]].concat(f))},firstValue=function(c){return'object'===('undefined'==typeof c?'undefined':_typeof(c))?c[Object.keys(c)[0]]:c[0]},getFileName=function(c){if(Array.isArray(c)&&(c=c[0]),!!c){if(-1!==c.indexOf(':')){var d=c.split(':'),e=_slicedToArray(d,2),f=e[1];return f}return c}};function wikiPage(c,d){function e(){return(0,_util.api)(d,{prop:'revisions',rvprop:'content',rvlimit:1,rvparse:'',titles:y.title}).then(function(A){return A.query.pages[y.pageid].revisions[0]['*']})}function f(){return g().then(_util.parseContent)}function g(){return(0,_util.api)(d,{prop:'extracts',explaintext:'',titles:y.title}).then(function(A){return A.query.pages[y.pageid].extract})}function j(){return(0,_util.api)(d,{generator:'images',gimlimit:'max',prop:'imageinfo',iiprop:'url',titles:y.title}).then(function(A){return A.query?Object.keys(A.query.pages).map(function(B){return A.query.pages[B]}):[]})}function r(A){return(0,_util.api)(d,{prop:'revisions',rvprop:'content',rvsection:0,titles:A||y.title}).then(function(B){return get(B,'query','pages',firstValue,'revisions',0,'*')})}function t(A){return r().then(function(B){var C=(0,_infoboxParser2.default)(B,d.parser).general;return 0===Object.keys(C).length?r('Template:Infobox '+y.title.toLowerCase()).then(function(D){return(0,_infoboxParser2.default)(D||'',d.parser).general}):C}).then(function(B){return A?B.hasOwnProperty(A)?B[A]:void 0:B})}var y=c;return{raw:y,html:e,rawContent:g,content:f,sections:f,summary:function(){return(0,_util.api)(d,{prop:'extracts',explaintext:'',exintro:'',titles:y.title}).then(function(A){return A.query.pages[y.pageid].extract})},images:function(){return j().then(function(A){return A.map(function(B){return B.imageinfo}).reduce(function(B,C){return[].concat(_toConsumableArray(B),_toConsumableArray(C))},[]).map(function(B){return B.url})})},references:function(){return e().then(_cheerio2.default.load).then(function(A){return A('.references cite a.external').map(function(){return A(this).attr('href')}).get()})},links:function(){var A=0<arguments.length&&arguments[0]!==void 0?arguments[0]:!0,B=1<arguments.length&&arguments[1]!==void 0?arguments[1]:100,C=(0,_util.pagination)(d,{prop:'links',plnamespace:0,pllimit:B,titles:y.title},function(D){return D.query.pages[y.pageid].links.map(function(E){return E.title})});return A?(0,_util.aggregatePagination)(C):C},externalLinks:function(){return(0,_util.api)(d,{prop:'extlinks',ellimit:'max',titles:y.title}).then(function(A){return A.query.pages[y.pageid].extlinks.map(function(B){return B['*']})})},categories:function(){var A=0<arguments.length&&arguments[0]!==void 0?arguments[0]:!0,B=1<arguments.length&&arguments[1]!==void 0?arguments[1]:100,C=(0,_util.pagination)(d,{prop:'categories',pllimit:B,titles:y.title},function(D){return D.query.pages[y.pageid].categories.map(function(E){return E.title})});return A?(0,_util.aggregatePagination)(C):C},coordinates:function(){return(0,_util.api)(d,{prop:'coordinates',titles:y.title}).then(function(A){var B=A.query.pages[y.pageid];return B.coordinates?B.coordinates[0]:t().then(function(C){return(0,_coordinates.parseCoordinates)(C)})})},info:t,backlinks:function(){var A=0<arguments.length&&arguments[0]!==void 0?arguments[0]:!0,B=1<arguments.length&&arguments[1]!==void 0?arguments[1]:100,C=(0,_util.pagination)(d,{list:'backlinks',bllimit:B,bltitle:y.title},function(D){return D.query.backlinks.map(function(E){return E.title})});return A?(0,_util.aggregatePagination)(C):C},rawImages:j,mainImage:function(){return Promise.all([j(),t()]).then(function(A){var B=_slicedToArray(A,2),C=B[0],D=B[1],E=getFileName(D.image||D.bildname||D.imagen||D.Immagine||D.badge||D.logo);if(!E)return r().then(function(G){if(C.length){C.sort(function(I,J){return G.indexOf(J.title)-G.indexOf(I.title)});var H=C[0];return 0<H.imageinfo.length?H.imageinfo[0].url:void 0}});var F=C.find(function(G){var H=G.title,I=getFileName(H);return I.toUpperCase()===E.toUpperCase()||I.replace(/\s/g,'_')===E});return F&&0<F.imageinfo.length?F.imageinfo[0].url:void 0})},langlinks:function(){return(0,_util.api)(d,{prop:'langlinks',lllimit:'max',titles:y.title}).then(function(A){return A.query.pages[y.pageid].langlinks.map(function(B){return{lang:B.lang,title:B['*']}})})},rawInfo:r,fullInfo:function(){return r().then(function(A){return(0,_infoboxParser2.default)(A,d.parser)})},tables:function(){return(0,_util.api)(d,{prop:'revisions',rvprop:'content',titles:y.title}).then(function(A){return get(A,'query','pages',firstValue,'revisions',0,'*')}).then(function(A){return(0,_infoboxParser2.default)(A,d.parser).tables})},url:function(){return y.canonicalurl}}}
//# sourceMappingURL=page.js.map